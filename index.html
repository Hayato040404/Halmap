<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—ãƒ«ãƒ¼ãƒˆæ¤œç´¢</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 12px;
            transition: opacity 0.3s;
        }
        .search-container.hidden { opacity: 0; pointer-events: none; }
        .input-field {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-size: 16px;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }
        .input-field:focus { border-color: #1a73e8; }
        .button {
            background: #1a73e8;
            color: white;
            border-radius: 4px;
            padding: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .button:hover { background: #1557b0; }
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .autocomplete-item:hover { background: #f1f3f4; }
        .directions-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            max-height: 400px;
            background: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
            padding: 16px;
            z-index: 1000;
            display: none;
            overflow-y: auto;
        }
        .directions-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .step-card {
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: border-left 0.2s;
        }
        .step-card.active {
            border-left: 4px solid #1a73e8;
            background: #e8f0fe;
        }
        .step-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            color: #1a73e8;
        }
        .step-info {
            flex: 1;
        }
        .step-distance {
            color: #555;
            font-size: 12px;
            margin-left: auto;
        }
        .current-location {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #1a73e8;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        .current-location:hover { background: #1557b0; }
        @media (max-width: 600px) {
            .current-location {
                top: 10px;
                left: 10px;
                padding: 10px 14px;
                font-size: 14px;
            }
            .search-container {
                top: 60px;
                width: 95%;
            }
        }
        @media (hover: none) {
            .current-location:hover { background: #1a73e8; }
            .button:hover { background: #1a73e8; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="current-location" onclick="getCurrentLocation()">ç¾åœ¨åœ°ã‚’ä½¿ç”¨</button>
    <div class="search-container" id="search-container">
        <div class="flex flex-col gap-2 mb-2">
            <div class="relative">
                <input id="start" type="text" placeholder="å‡ºç™ºåœ°" class="input-field" oninput="autocomplete(this, 'start-suggestions')">
                <div id="start-suggestions" class="autocomplete-dropdown hidden"></div>
            </div>
            <div class="relative">
                <input id="end" type="text" placeholder="ç›®çš„åœ°" class="input-field" oninput="autocomplete(this, 'end-suggestions')">
                <div id="end-suggestions" class="autocomplete-dropdown hidden"></div>
            </div>
            <select id="mode" class="input-field">
                <option value="driving-car">è»Š</option>
                <option value="foot-walking">å¾’æ­©</option>
                <option value="public-transport">å…¬å…±äº¤é€šæ©Ÿé–¢</option>
            </select>
            <button onclick="findRoute()" class="button">ãƒ«ãƒ¼ãƒˆæ¤œç´¢</button>
        </div>
    </div>
    <div id="directions" class="directions-panel">
        <div class="directions-header">
            <h2 class="text-lg font-medium text-gray-800">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h2>
            <p id="route-summary" class="text-sm text-gray-600"></p>
        </div>
        <ul id="instructions" class="text-sm text-gray-600"></ul>
        <button onclick="exitNavigation()" class="button mt-4 w-full">ãƒŠãƒ“çµ‚äº†</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ORS APIã‚­ãƒ¼ï¼ˆCodePenã§ã¯ç›´æ¥è¨˜è¼‰ã—ãªã„ï¼ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã§ç®¡ç†ï¼‰
        const apiKey = '5b3ce3597851110001cf6248971ea2d628e74c31a7db0572d1dbc101'; // https://openrouteservice.org/ ã§å–å¾—ã—ãŸã‚­ãƒ¼ã‚’å…¥åŠ›

        // åœ°å›³ã®åˆæœŸåŒ–
        const map = L.map('map').setView([35.6762, 139.6503], 13); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ±äº¬
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let routeLayer = null;
        let currentLocationMarker = null;
        let isNavigating = false;

        // ç¾åœ¨åœ°ã®å–å¾—
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç¾åœ¨åœ°å–å¾—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('start').value = 'ç¾åœ¨åœ°';
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    currentLocationMarker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#1a73e8',
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(map);
                    map.setView([lat, lon], 15);
                },
                (error) => {
                    alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
                }
            );
        }

        // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ˆORS Pelias APIï¼‰
        async function autocomplete(input, suggestionsId) {
            const query = input.value;
            if (query.length < 3) {
                document.getElementById(suggestionsId).classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`https://api.openrouteservice.org/geocode/autocomplete?text=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': apiKey }
                });
                if (!response.ok) {
                    throw new Error(`ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆAPIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                const suggestions = document.getElementById(suggestionsId);
                suggestions.innerHTML = '';
                if (data.features.length > 0) {
                    data.features.forEach(feature => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.textContent = feature.properties.label;
                        item.onclick = () => {
                            input.value = feature.properties.label;
                            suggestions.classList.add('hidden');
                        };
                        suggestions.appendChild(item);
                    });
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            } catch (error) {
                console.error('ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆåœ°åâ†’åº§æ¨™ï¼‰
        async function geocode(location) {
            if (location === 'ç¾åœ¨åœ°') {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('ç¾åœ¨åœ°å–å¾—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve([position.coords.latitude, position.coords.longitude]),
                        (error) => reject(new Error('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message))
                    );
                });
            }
            try {
                const response = await fetch(`https://api.openrouteservice.org/geocode/search?text=${encodeURIComponent(location)}`, {
                    headers: { 'Authorization': apiKey }
                });
                if (!response.ok) {
                    throw new Error(`ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                if (data.features.length > 0) {
                    return data.features[0].geometry.coordinates.reverse(); // [lat, lon]
                }
                throw new Error('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            } catch (error) {
                throw new Error('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ«ãƒ¼ãƒˆæ¤œç´¢
        async function findRoute() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const mode = document.getElementById('mode').value;
            if (!start || !end) {
                alert('å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                // å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã®åº§æ¨™ã‚’å–å¾—
                const startCoords = await geocode(start);
                const endCoords = await geocode(end);

                // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
                let endpoint = `https://api.openrouteservice.org/v2/directions/${mode}/geojson`;
                if (mode === 'public-transport') {
                    endpoint = 'https://api.openrouteservice.org/v2/directions/public-transport';
                }

                // ãƒ«ãƒ¼ãƒˆå–å¾—ï¼ˆæ¡ˆå†…å«ã‚€ï¼‰
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        coordinates: [startCoords.reverse(), endCoords.reverse()],
                        instructions: true
                    })
                });
                if (!response.ok) {
                    if (mode === 'public-transport') {
                        alert('å…¬å…±äº¤é€šæ©Ÿé–¢ã®ãƒ«ãƒ¼ãƒˆæ¤œç´¢ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚å¾’æ­©ãƒ«ãƒ¼ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
                        document.getElementById('mode').value = 'foot-walking';
                        return findRoute(); // å¾’æ­©ã§ãƒªãƒˆãƒ©ã‚¤
                    }
                    throw new Error(`ãƒ«ãƒ¼ãƒˆAPIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                const routeData = await response.json();

                // å‰ã®ãƒ«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }

                // æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’åœ°å›³ã«è¿½åŠ ï¼ˆGoogle Mapsé¢¨ã®é’ã„ç·šï¼‰
                routeLayer = L.geoJSON(routeData, {
                    style: { color: '#1a73e8', weight: 5, opacity: 0.8 }
                }).addTo(map);
                map.fitBounds(routeLayer.getBounds());

                // ãƒ«ãƒ¼ãƒˆæ¦‚è¦ï¼ˆè·é›¢ã€æ‰€è¦æ™‚é–“ï¼‰
                const summary = document.getElementById('route-summary');
                const distance = (routeData.features[0].properties.summary.distance / 1000).toFixed(1);
                const duration = Math.round(routeData.features[0].properties.summary.duration / 60);
                summary.textContent = `è·é›¢: ${distance}km | æ‰€è¦æ™‚é–“: ${duration}åˆ†`;

                // æ¡ˆå†…ã‚’è¡¨ç¤ºï¼ˆGoogle Mapsé¢¨ï¼‰
                const instructionsList = document.getElementById('instructions');
                instructionsList.innerHTML = '';
                if (routeData.features && routeData.features[0].properties && routeData.features[0].properties.segments) {
                    routeData.features[0].properties.segments.forEach(segment => {
                        segment.steps.forEach((step, index) => {
                            const li = document.createElement('li');
                            li.className = `step-card ${index === 0 && start === 'ç¾åœ¨åœ°' ? 'active' : ''}`;
                            const icon = getStepIcon(step.type);
                            const distance = (step.distance / 1000).toFixed(1);
                            const duration = Math.round(step.duration / 60);
                            li.innerHTML = `
                                <span class="step-icon">${icon}</span>
                                <span class="step-info">${step.instruction}</span>
                                <span class="step-distance">${distance}km, ${duration}åˆ†</span>
                            `;
                            instructionsList.appendChild(li);
                        });
                    });
                } else {
                    instructionsList.innerHTML = '<li class="step-card">æ¡ˆå†…æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</li>';
                }

                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                isNavigating = true;
                document.getElementById('search-container').classList.add('hidden');
                document.getElementById('directions').style.display = 'block';

                // ç¾åœ¨åœ°ã®è¿½è·¡ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ï¼‰
                if (start === 'ç¾åœ¨åœ°' && navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            if (currentLocationMarker) {
                                map.removeLayer(currentLocationMarker);
                            }
                            currentLocationMarker = L.circleMarker([lat, lon], {
                                radius: 8,
                                fillColor: '#1a73e8',
                                color: '#fff',
                                weight: 2,
                                fillOpacity: 1
                            }).addTo(map);
                            if (isNavigating) {
                                map.panTo([lat, lon]);
                                // ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
                                updateStepHighlight(lat, lon, routeData.features[0].properties.segments);
                            }
                        },
                        (error) => {
                            console.error('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                        },
                        { enableHighAccuracy: true }
                    );
                }
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        function getStepIcon(type) {
            switch (type) {
                case 0: return 'â†’'; // ç›´é€²
                case 1: return 'â†—'; // å³æŠ˜
                case 2: return 'â†–'; // å·¦æŠ˜
                case 10: return 'ğŸ'; // åˆ°ç€
                default: return 'â¡';
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        function updateStepHighlight(lat, lon, segments) {
            const steps = document.querySelectorAll('.step-card');
            steps.forEach((step, index) => {
                step.classList.remove('active');
                if (index === 0) step.classList.add('active'); // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä»®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            });
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
        function exitNavigation() {
            isNavigating = false;
            document.getElementById('search-container').classList.remove('hidden');
            document.getElementById('directions').style.display = 'none';
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            document.getElementById('instructions').innerHTML = '';
            document.getElementById('route-summary').textContent = '';
            map.setView([35.6762, 139.6503], 13); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ“ãƒ¥ãƒ¼ã«ãƒªã‚»ãƒƒãƒˆ
        }

        // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å¤–ã‚¯ãƒªãƒƒã‚¯ã§éè¡¨ç¤º
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('start-suggestions').classList.add('hidden');
                document.getElementById('end-suggestions').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
