<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—ãƒ«ãƒ¼ãƒˆæ¤œç´¢</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif; 
            margin: 0; 
            overflow: hidden; 
            background: #FFFFFF; 
            color: #333; 
            transition: background 0.3s, color 0.3s;
        }
        body.dark-mode {
            background: #121212;
            color: #FFFFFF;
        }
        #map { 
            height: 100vh; 
            width: 100vw; 
            opacity: 0; 
            transition: opacity 0.5s ease; 
        }
        #map.visible { 
            opacity: 1; 
        }
        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeOut 0.5s ease 2.5s forwards;
        }
        #splash-screen .splash-text {
            text-align: center;
            animation: fadeInScale 1s ease forwards;
        }
        #splash-screen .splash-made-in {
            font-size: 16px;
            color: #CCCCCC;
            font-weight: 400;
        }
        #splash-screen .splash-grok {
            font-size: 32px;
            color: #FFFFFF;
            font-weight: 700;
        }
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        /* æ¤œç´¢ã‚³ãƒ³ãƒ†ãƒŠ */
        .search-container {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 12px;
            transition: opacity 0.3s, background 0.3s;
        }
        .dark-mode .search-container {
            background: rgba(30, 30, 30, 0.9);
        }
        .search-container.hidden { 
            opacity: 0; 
            pointer-events: none; 
        }
        .input-field {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            width: 100%;
            outline: none;
            transition: border-color 0.3s, background 0.3s;
            margin-bottom: 8px;
            background: #FFFFFF;
            color: #333;
        }
        .dark-mode .input-field {
            border-color: #444;
            background: #1E1E1E;
            color: #FFFFFF;
        }
        .input-field:focus { 
            border-color: #007AFF; 
        }
        .button {
            background: #007AFF;
            color: white;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            width: 100%;
        }
        .button:hover { 
            background: #005BB5; 
        }
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }
        .dark-mode .autocomplete-dropdown {
            background: #1E1E1E;
            border-color: #444;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        .dark-mode .autocomplete-item {
            color: #FFFFFF;
        }
        .autocomplete-item:hover { 
            background: #F5F5F5; 
        }
        .dark-mode .autocomplete-item:hover {
            background: #2A2A2A;
        }
        /* ç›®çš„åœ°é¸æŠãƒªã‚¹ãƒˆ */
        .location-list {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1002;
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 12px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            transition: background 0.3s;
        }
        .dark-mode .location-list {
            background: #1E1E1E;
        }
        .location-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        .dark-mode .location-item {
            border-color: #444;
            color: #FFFFFF;
        }
        .location-item:last-child {
            border-bottom: none;
        }
        .location-item:hover {
            background: #F5F5F5;
        }
        .dark-mode .location-item:hover {
            background: #2A2A2A;
        }
        .location-name {
            font-weight: 500;
        }
        .location-address {
            font-size: 12px;
            color: #666;
        }
        .dark-mode .location-address {
            color: #BBBBBB;
        }
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« */
        .directions-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            max-height: 400px;
            background: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
            padding: 12px;
            z-index: 1000;
            display: none;
            overflow-y: auto;
            transition: max-height 0.3s ease, background 0.3s;
        }
        .dark-mode .directions-panel {
            background: #1E1E1E;
        }
        .directions-panel.collapsed {
            max-height: 56px;
            overflow: hidden;
        }
        .directions-header {
            display: flex;
            align-items: center;
            background: #F5F5F5;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            transition: background 0.3s;
        }
        .dark-mode .directions-header {
            background: #2A2A2A;
        }
        .directions-header h2 {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .dark-mode .directions-header h2 {
            color: #FFFFFF;
        }
        .toggle-collapse {
            margin-left: auto;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }
        .dark-mode .toggle-collapse {
            color: #BBBBBB;
        }
        .minimize-panel {
            margin-left: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }
        .dark-mode .minimize-panel {
            color: #BBBBBB;
        }
        .restore-panel {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: #007AFF;
            color: white;
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            z-index: 1001;
            display: none;
            cursor: pointer;
            font-size: 16px;
        }
        .step-card {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 400;
            transition: background 0.3s, border-color 0.3s;
        }
        .dark-mode .step-card {
            background: #1E1E1E;
            border-color: #444;
        }
        .step-card.active {
            border-left: 3px solid #007AFF;
            background: #F5F5F5;
        }
        .dark-mode .step-card.active {
            background: #2A2A2A;
        }
        .step-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            color: #007AFF;
        }
        .step-info {
            flex: 1;
            color: #333;
        }
        .dark-mode .step-info {
            color: #FFFFFF;
        }
        .step-distance {
            color: #666;
            font-size: 12px;
            margin-left: auto;
        }
        .dark-mode .step-distance {
            color: #BBBBBB;
        }
        /* ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰ã®æ¡ˆå†…ãƒœãƒƒã‚¯ã‚¹ */
        .navigation-box {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            background: #34C759;
            color: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            z-index: 1002;
            display: none;
            text-align: center;
        }
        .navigation-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .navigation-text {
            font-size: 18px;
            font-weight: 500;
        }
        .navigation-distance {
            font-size: 14px;
            color: #E8F5E9;
        }
        /* ãƒ«ãƒ¼ãƒˆæ¦‚è¦ */
        .route-summary {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 1000;
            color: #333;
            transition: background 0.3s, color 0.3s;
        }
        .dark-mode .route-summary {
            background: rgba(30, 30, 30, 0.9);
            color: #FFFFFF;
        }
        /* åœ°å›³ä¸Šã®ãƒœã‚¿ãƒ³ */
        .current-location, .refresh-location, .mode-toggle, .dark-mode-toggle {
            position: absolute;
            right: 16px;
            z-index: 1001;
            background: white;
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 16px;
            color: #333;
            transition: background 0.3s, color 0.3s;
        }
        .dark-mode .current-location,
        .dark-mode .refresh-location,
        .dark-mode .mode-toggle,
        .dark-mode .dark-mode-toggle {
            background: #1E1E1E;
            color: #FFFFFF;
        }
        .current-location { top: 16px; }
        .refresh-location { top: 72px; }
        .mode-toggle { top: 128px; }
        .dark-mode-toggle { top: 184px; }
        .start-navigation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: #007AFF;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: none;
        }
        /* ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
        @media (max-width: 600px) {
            .search-container {
                top: 12px;
                width: 95%;
            }
            .location-list {
                width: 95%;
            }
            .navigation-box {
                top: 12px;
                padding: 10px;
            }
            .start-navigation {
                padding: 10px 20px;
                font-size: 14px;
            }
            .current-location, .refresh-location, .mode-toggle, .dark-mode-toggle {
                padding: 8px;
                font-size: 14px;
            }
            .current-location { top: 12px; right: 12px; }
            .refresh-location { top: 64px; }
            .mode-toggle { top: 116px; }
            .dark-mode-toggle { top: 168px; }
        }
        @media (hover: none) {
            .button:hover, .start-navigation:hover { background: #007AFF; }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ -->
    <div id="splash-screen">
        <div class="splash-text">
            <div class="splash-made-in">Made in with</div>
            <div class="splash-grok">Grok</div>
        </div>
    </div>
    <div id="map"></div>
    <button class="current-location" onclick="getCurrentLocation()" onmousedown="startZoomTimer()" onmouseup="clearZoomTimer()" ontouchstart="startZoomTimer()" ontouchend="clearZoomTimer()">ğŸ“</button>
    <button class="refresh-location" onclick="refreshLocation()">ğŸ”„</button>
    <button id="mode-toggle" class="mode-toggle" onclick="toggleMode()">ğŸ–¥ï¸</button>
    <button id="dark-mode-toggle" class="dark-mode-toggle" onclick="toggleDarkMode()">ğŸŒ™</button>
    <button id="start-navigation" class="start-navigation" onclick="startNavigation()">æ¡ˆå†…é–‹å§‹</button>
    <div class="search-container" id="search-container">
        <div class="flex flex-col gap-2">
            <div class="relative">
                <input id="start" type="text" placeholder="å‡ºç™ºåœ°" class="input-field" oninput="autocomplete(this, 'start-suggestions', 'start')">
                <div id="start-suggestions" class="autocomplete-dropdown hidden"></div>
            </div>
            <div class="relative">
                <input id="end" type="text" placeholder="ç›®çš„åœ°" class="input-field" oninput="autocomplete(this, 'end-suggestions', 'end')">
                <div id="end-suggestions" class="autocomplete-dropdown hidden"></div>
            </div>
            <select id="mode" class="input-field">
                <option value="driving-car">è»Š</option>
                <option value="foot-walking">å¾’æ­©</option>
                <option value="public-transport">å…¬å…±äº¤é€šæ©Ÿé–¢</option>
            </select>
            <button onclick="findRoute()" class="button">ãƒ«ãƒ¼ãƒˆæ¤œç´¢</button>
        </div>
    </div>
    <div id="location-list" class="location-list"></div>
    <div id="directions" class="directions-panel">
        <div class="directions-header">
            <h2>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h2>
            <span id="toggle-collapse" class="toggle-collapse" onclick="toggleCollapse()">â–¼</span>
            <span id="minimize-panel" class="minimize-panel" onclick="minimizePanel()">â€”</span>
        </div>
        <p id="route-summary" class="text-sm text-gray-600 mb-4"></p>
        <ul id="instructions" class="text-sm text-gray-600"></ul>
        <button onclick="shareRoute()" class="button mt-2 w-full">ãƒ«ãƒ¼ãƒˆã‚’å…±æœ‰</button>
        <button onclick="recalculateRoute()" class="button mt-2 w-full">ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—</button>
        <button onclick="exitNavigation()" class="button mt-2 w-full">ãƒŠãƒ“çµ‚äº†</button>
    </div>
    <button id="restore-panel" class="restore-panel" onclick="restorePanel()">â†‘</button>
    <div id="navigation-box" class="navigation-box">
        <button onclick="shareRoute()" class="button mt-2 w-full">ãƒ«ãƒ¼ãƒˆã‚’å…±æœ‰</button>
        <button onclick="recalculateRoute()" class="button mt-2 w-full">ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—</button>
    </div>
    <div id="route-summary-bottom" class="route-summary"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢å¾Œã«åœ°å›³ã‚’è¡¨ç¤º
        setTimeout(() => {
            document.getElementById('map').classList.add('visible');
        }, 3000);

        // ORS APIã‚­ãƒ¼ï¼ˆCodePenã§ã¯ç›´æ¥è¨˜è¼‰ã—ãªã„ï¼ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã§ç®¡ç†ï¼‰
        const apiKey = '5b3ce3597851110001cf6248971ea2d628e74c31a7db0572d1dbc101'; // https://openrouteservice.org/ ã§å–å¾—ã—ãŸã‚­ãƒ¼ã‚’å…¥åŠ›

        // æ­©è¡Œé€Ÿåº¦ï¼ˆm/åˆ†ï¼‰
        const WALKING_SPEED = 80;

        // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–ï¼‰
        const map = L.map('map', {
            zoomControl: true
        }).setView([35.6762, 139.6503], 13); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ±äº¬

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã‚¿ã‚¤ãƒ«
        let lightTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        let darkTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© <a href="https://carto.com/attributions">CARTO</a>'
        });
        lightTile.addTo(map);

        let routeLayer = null;
        let currentLocationMarker = null;
        let isNavigating = false;
        let navigationMode = false;
        let routeDataCache = null;
        let destination = null;
        let locationCandidates = [];
        let currentInputField = null;
        let zoomTimer = null;

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            map.removeLayer(isDarkMode ? lightTile : darkTile);
            (isDarkMode ? darkTile : lightTile).addTo(map);
            document.getElementById('dark-mode-toggle').textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('darkMode', isDarkMode);
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸçŠ¶æ…‹
        if (localStorage.getItem('darkMode') === 'true') {
            toggleDarkMode();
        }

        // ç¾åœ¨åœ°ã®å–å¾—
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç¾åœ¨åœ°å–å¾—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('start').value = 'ç¾åœ¨åœ°';
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    currentLocationMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'current-location-icon',
                            html: '<div style="background: #007AFF; border-radius: 50%; width: 12px; height: 12px; border: 2px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.2);"></div>',
                            iconSize: [12, 12]
                        })
                    }).addTo(map);
                    map.setView([lat, lon], 15);
                },
                (error) => {
                    alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
                }
            );
        }

        // ç¾åœ¨åœ°ã®æ›´æ–°
        function refreshLocation() {
            getCurrentLocation();
        }

        // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³é•·æŠ¼ã—ã§ã‚ºãƒ¼ãƒ 
        function startZoomTimer() {
            zoomTimer = setTimeout(() => {
                if (currentLocationMarker) {
                    const pos = currentLocationMarker.getLatLng();
                    map.setView([pos.lat, pos.lng], 18);
                }
            }, 1000);
        }

        function clearZoomTimer() {
            clearTimeout(zoomTimer);
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function toggleMode() {
            navigationMode = !navigationMode;
            document.getElementById('mode-toggle').textContent = navigationMode ? 'ğŸ–¥ï¸' : 'ğŸ“‹';
            updateNavigationDisplay();
        }

        // ãƒ‘ãƒãƒ«ã®æŠ˜ã‚Šç•³ã¿
        function toggleCollapse() {
            const panel = document.getElementById('directions');
            const toggleBtn = document.getElementById('toggle-collapse');
            panel.classList.toggle('collapsed');
            toggleBtn.textContent = panel.classList.contains('collapsed') ? 'â–²' : 'â–¼';
        }

        // ãƒ‘ãƒãƒ«ã®æœ€å°åŒ–
        function minimizePanel() {
            document.getElementById('directions').style.display = 'none';
            document.getElementById('restore-panel').style.display = 'block';
        }

        // ãƒ‘ãƒãƒ«ã®å¾©å…ƒ
        function restorePanel() {
            document.getElementById('directions').style.display = 'block';
            document.getElementById('restore-panel').style.display = 'none';
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã®æ›´æ–°
        function updateNavigationDisplay() {
            const directions = document.getElementById('directions');
            const navigationBox = document.getElementById('navigation-box');
            if (navigationMode) {
                directions.style.display = 'none';
                navigationBox.style.display = 'block';
                document.getElementById('search-container').classList.add('hidden');
            } else {
                directions.style.display = 'block';
                navigationBox.style.display = 'none';
                if (!isNavigating) document.getElementById('search-container').classList.remove('hidden');
            }
        }

        // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ˆORS Pelias APIï¼‰
        async function autocomplete(input, suggestionsId, field) {
            const query = input.value;
            if (query.length < 3) {
                document.getElementById(suggestionsId).classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`https://api.openrouteservice.org/geocode/autocomplete?text=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': apiKey }
                });
                if (!response.ok) {
                    throw new Error(`ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆAPIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                const suggestions = document.getElementById(suggestionsId);
                suggestions.innerHTML = '';
                if (data.features.length > 0) {
                    data.features.forEach(feature => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.textContent = feature.properties.label;
                        item.onclick = () => {
                            input.value = feature.properties.label;
                            suggestions.classList.add('hidden');
                            if (field === 'end') {
                                showLocationList(data.features, field);
                            } else {
                                currentInputField = null;
                                locationCandidates = [];
                            }
                        };
                        suggestions.appendChild(item);
                    });
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            } catch (error) {
                console.error('ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ç›®çš„åœ°å€™è£œãƒªã‚¹ãƒˆè¡¨ç¤º
        function showLocationList(features, field) {
            currentInputField = field;
            locationCandidates = features;
            const list = document.getElementById('location-list');
            list.innerHTML = '';
            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'location-item';
                item.innerHTML = `
                    <div class="location-name">${feature.properties.name || feature.properties.label}</div>
                    <div class="location-address">${feature.properties.label}</div>
                `;
                item.onclick = () => {
                    document.getElementById(field).value = feature.properties.label;
                    list.style.display = 'none';
                    currentInputField = null;
                    locationCandidates = [];
                };
                list.appendChild(item);
            });
            list.style.display = 'block';
        }

        // ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆåœ°åâ†’åº§æ¨™ï¼‰
        async function geocode(location) {
            if (location === 'ç¾åœ¨åœ°') {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('ç¾åœ¨åœ°å–å¾—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve([position.coords.latitude, position.coords.longitude]),
                        (error) => reject(new Error('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message))
                    );
                });
            }
            try {
                const response = await fetch(`https://api.openrouteservice.org/geocode/search?text=${encodeURIComponent(location)}`, {
                    headers: { 'Authorization': apiKey }
                });
                if (!response.ok) {
                    throw new Error(`ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                if (data.features.length > 0) {
                    return data.features[0].geometry.coordinates.reverse(); // [lat, lon]
                }
                throw new Error('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            } catch (error) {
                throw new Error('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ«ãƒ¼ãƒˆæ¤œç´¢
        async function findRoute() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const mode = document.getElementById('mode').value;
            if (!start || !end) {
                alert('å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const startCoords = await geocode(start);
                const endCoords = await geocode(end);
                destination = end;

                let endpoint = `https://api.openrouteservice.org/v2/directions/${mode}/geojson`;
                if (mode === 'public-transport') {
                    endpoint = 'https://api.openrouteservice.org/v2/directions/public-transport';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        coordinates: [startCoords.reverse(), endCoords.reverse()],
                        instructions: true
                    })
                });
                if (!response.ok) {
                    if (mode === 'public-transport') {
                        alert('å…¬å…±äº¤é€šæ©Ÿé–¢ã®ãƒ«ãƒ¼ãƒˆæ¤œç´¢ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚å¾’æ­©ãƒ«ãƒ¼ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
                        document.getElementById('mode').value = 'foot-walking';
                        return findRoute();
                    }
                    throw new Error(`ãƒ«ãƒ¼ãƒˆAPIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                routeDataCache = await response.json();

                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }

                routeLayer = L.geoJSON(routeDataCache, {
                    style: { color: '#007AFF', weight: 5, opacity: 0.8 }
                }).addTo(map);
                map.fitBounds(routeLayer.getBounds());

                const totalDistance = routeDataCache.features[0].properties.summary.distance;
                let duration;
                if (mode === 'foot-walking') {
                    duration = Math.ceil(totalDistance / WALKING_SPEED);
                } else {
                    duration = Math.round(routeDataCache.features[0].properties.summary.duration / 60);
                }
                document.getElementById('route-summary').textContent = `è·é›¢: ${(totalDistance / 1000).toFixed(1)}km | æ‰€è¦æ™‚é–“: ${duration}åˆ†`;
                document.getElementById('route-summary-bottom').textContent = `${(totalDistance / 1000).toFixed(1)}km - ${duration}:${(duration % 60).toString().padStart(2, '0')}`;

                const instructionsList = document.getElementById('instructions');
                instructionsList.innerHTML = '';
                if (routeDataCache.features && routeDataCache.features[0].properties && routeDataCache.features[0].properties.segments) {
                    routeDataCache.features[0].properties.segments.forEach(segment => {
                        segment.steps.forEach((step, index) => {
                            const li = document.createElement('li');
                            li.className = `step-card ${index === 0 && start === 'ç¾åœ¨åœ°' ? 'active' : ''}`;
                            const icon = getStepIcon(step.type);
                            const stepDistance = (step.distance / 1000).toFixed(1);
                            const stepDuration = mode === 'foot-walking' ? Math.ceil(step.distance / WALKING_SPEED) : Math.round(step.duration / 60);
                            li.innerHTML = `
                                <span class="step-icon">${icon}</span>
                                <span class="step-info">${step.instruction}</span>
                                <span class="step-distance">${stepDistance}km, ${stepDuration}åˆ†</span>
                            `;
                            li.onclick = () => speakInstruction(step.instruction);
                            instructionsList.appendChild(li);
                        });
                    });
                } else {
                    instructionsList.innerHTML = '<li class="step-card">æ¡ˆå†…æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</li>';
                }

                document.getElementById('start-navigation').style.display = 'block';
                document.getElementById('search-container').classList.add('hidden');
                document.getElementById('location-list').style.display = 'none';
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // éŸ³å£°æ¡ˆå†…
        function speakInstruction(instruction) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(instruction);
                utterance.lang = 'ja-JP';
                speechSynthesis.speak(utterance);
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°æ¡ˆå†…ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }
        }

        // ãƒ«ãƒ¼ãƒˆå…±æœ‰
        function shareRoute() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const mode = document.getElementById('mode').value;
            const url = `${window.location.origin}${window.location.pathname}?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&mode=${mode}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('ãƒ«ãƒ¼ãƒˆURLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼');
            });
        }

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ«ãƒ¼ãƒˆã‚’å¾©å…ƒ
        function loadRouteFromURL() {
            const params = new URLSearchParams(window.location.search);
            const start = params.get('start');
            const end = params.get('end');
            const mode = params.get('mode');
            if (start && end && mode) {
                document.getElementById('start').value = start;
                document.getElementById('end').value = end;
                document.getElementById('mode').value = mode;
                findRoute();
            }
        }

        // æ¡ˆå†…é–‹å§‹
        function startNavigation() {
            document.getElementById('start-navigation').style.display = 'none';
            isNavigating = true;
            updateNavigationDisplay();

            if (navigationMode) {
                const firstStep = routeDataCache.features[0].properties.segments[0].steps[0];
                updateNavigationBox(firstStep, (routeDataCache.features[0].properties.summary.distance / 1000).toFixed(1), Math.ceil(routeDataCache.features[0].properties.summary.distance / WALKING_SPEED));
                speakInstruction(firstStep.instruction);
            }

            if (document.getElementById('start').value === 'ç¾åœ¨åœ°' && navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        if (currentLocationMarker) {
                            map.removeLayer(currentLocationMarker);
                        }
                        currentLocationMarker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'current-location-icon',
                                html: '<div style="background: #007AFF; border-radius: 50%; width: 12px; height: 12px; border: 2px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.2);"></div>',
                                iconSize: [12, 12]
                            })
                        }).addTo(map);
                        map.setView([lat, lon], 15);
                        if (navigationMode) {
                            updateNavigationBoxBasedOnLocation(routeDataCache.features[0].properties.segments, lat, lon);
                        }
                    },
                    (error) => {
                        console.error('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        // ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—
        async function recalculateRoute() {
            if (!destination) {
                alert('ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            document.getElementById('start').value = 'ç¾åœ¨åœ°';
            document.getElementById('end').value = destination;
            await findRoute();
            startNavigation();
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getStepIcon(type) {
            switch (type) {
                case 0: return 'â†’';
                case 1: return 'â†—';
                case 2: return 'â†–';
                case 10: return 'ğŸ';
                default: return 'â¡';
            }
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœãƒƒã‚¯ã‚¹ã®æ›´æ–°
        function updateNavigationBox(step, totalDistance, totalDuration) {
            const box = document.getElementById('navigation-box');
            const icon = getNavigationIcon(step.type);
            const stepDistance = (step.distance / 1000).toFixed(1);
            const stepDuration = document.getElementById('mode').value === 'foot-walking' ? Math.ceil(step.distance / WALKING_SPEED) : Math.round(step.duration / 60);
            box.innerHTML = `
                <div class="navigation-icon">${icon}</div>
                <div class="navigation-text">${step.instruction}</div>
                <div class="navigation-distance">${stepDistance}km - ${stepDuration}åˆ†</div>
                <button onclick="shareRoute()" class="button mt-2 w-full">ãƒ«ãƒ¼ãƒˆã‚’å…±æœ‰</button>
                <button onclick="recalculateRoute()" class="button mt-2 w-full">ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—</button>
            `;
            box.style.display = 'block';
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœãƒƒã‚¯ã‚¹ã®ä½ç½®ãƒ™ãƒ¼ã‚¹æ›´æ–°ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        function updateNavigationBoxBasedOnLocation(segments, lat, lon) {
            const steps = segments.flatMap(segment => segment.steps);
            const currentStep = steps.find(step => {
                return Math.abs(step.way_points[0][0] - lat) < 0.01 && Math.abs(step.way_points[0][1] - lon) < 0.01;
            }) || steps[0];
            updateNavigationBox(currentStep, (segments[0].distance / 1000).toFixed(1), Math.ceil(segments[0].distance / WALKING_SPEED));
            speakInstruction(currentStep.instruction);
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getNavigationIcon(type) {
            switch (type) {
                case 0: return 'â†‘';
                case 1: return 'â†—';
                case 2: return 'â†–';
                case 10: return 'ğŸ';
                default: return 'â†’';
            }
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
        function exitNavigation() {
            isNavigating = false;
            document.getElementById('search-container').classList.remove('hidden');
            document.getElementById('directions').style.display = 'none';
            document.getElementById('navigation-box').style.display = 'none';
            document.getElementById('restore-panel').style.display = 'none';
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            document.getElementById('instructions').innerHTML = '';
            document.getElementById('route-summary').textContent = '';
            document.getElementById('route-summary-bottom').textContent = '';
            map.setView([35.6762, 139.6503], 13);
            routeDataCache = null;
            destination = null;
        }

        // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³/å€™è£œãƒªã‚¹ãƒˆã‚’å¤–ã‚¯ãƒªãƒƒã‚¯ã§éè¡¨ç¤º
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('start-suggestions').classList.add('hidden');
                document.getElementById('end-suggestions').classList.add('hidden');
            }
            if (!e.target.closest('.location-list') && !e.target.closest('.search-container')) {
                document.getElementById('location-list').style.display = 'none';
                currentInputField = null;
                locationCandidates = [];
            }
        });

        // URLã‹ã‚‰ãƒ«ãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
        loadRouteFromURL();
    </script>
</body>
</html>
