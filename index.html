<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マップルート検索</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 12px;
            transition: opacity 0.3s;
        }
        .search-container.hidden { opacity: 0; pointer-events: none; }
        .input-field {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-size: 16px;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }
        .input-field:focus { border-color: #1a73e8; }
        .button {
            background: #1a73e8;
            color: white;
            border-radius: 4px;
            padding: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .button:hover { background: #1557b0; }
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .autocomplete-item:hover { background: #f1f3f4; }
        .directions-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            max-height: 400px;
            background: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
            padding: 16px;
            z-index: 1000;
            display: none;
            overflow-y: auto;
        }
        .directions-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .step-card {
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: border-left 0.2s;
        }
        .step-card.active {
            border-left: 4px solid #1a73e8;
            background: #e8f0fe;
        }
        .step-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            color: #1a73e8;
        }
        .step-info {
            flex: 1;
        }
        .step-distance {
            color: #555;
            font-size: 12px;
            margin-left: auto;
        }
        .navigation-box {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            background: #388e3c;
            color: white;
            padding: 12px 16px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1002;
            display: none;
            min-height: 80px;
            text-align: center;
        }
        .navigation-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .navigation-text {
            font-size: 16px;
            font-weight: 500;
        }
        .navigation-distance {
            font-size: 14px;
            color: #dcedc8;
        }
        .route-summary {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 1000;
        }
        .current-location {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #1a73e8;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        .current-location:hover { background: #1557b0; }
        .mode-toggle {
            position: absolute;
            top: 60px;
            left: 20px;
            z-index: 1001;
            background: #fff;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .current-location {
                top: 10px;
                left: 10px;
                padding: 10px 14px;
                font-size: 14px;
            }
            .search-container {
                top: 70px;
                width: 95%;
            }
            .navigation-box {
                top: 10px;
                padding: 10px 12px;
            }
            .mode-toggle {
                top: 50px;
                left: 10px;
            }
        }
        @media (hover: none) {
            .current-location:hover { background: #1a73e8; }
            .button:hover { background: #1a73e8; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="current-location" onclick="getCurrentLocation()">現在地を使用</button>
    <button id="mode-toggle" class="mode-toggle" onclick="toggleMode()">パネルモード</button>
    <div class="search-container" id="search-container">
        <div class="flex flex-col gap-2 mb-2">
            <div class="relative">
                <input id="start" type="text" placeholder="出発地" class="input-field" oninput="autocomplete(this, 'start-suggestions')">
                <div id="start-suggestions" class="autocomplete-dropdown hidden"></div>
            </div>
            <div class="relative">
                <input id="end" type="text" placeholder="目的地" class="input-field" oninput="autocomplete(this, 'end-suggestions')">
                <div id="end-suggestions" class="autocomplete-dropdown hidden"></div>
            </div>
            <select id="mode" class="input-field">
                <option value="driving-car">車</option>
                <option value="foot-walking">徒歩</option>
                <option value="public-transport">公共交通機関</option>
            </select>
            <button onclick="findRoute()" class="button">ルート検索</button>
        </div>
    </div>
    <div id="directions" class="directions-panel">
        <div class="directions-header">
            <h2 class="text-lg font-medium text-gray-800">ナビゲーション</h2>
            <p id="route-summary" class="text-sm text-gray-600"></p>
        </div>
        <ul id="instructions" class="text-sm text-gray-600"></ul>
        <button onclick="exitNavigation()" class="button mt-4 w-full">ナビ終了</button>
    </div>
    <div id="navigation-box" class="navigation-box"></div>
    <div id="route-summary-bottom" class="route-summary"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ORS APIキー（CodePenでは直接記載しない！ローカルまたはサーバーで管理）
        const apiKey = '5b3ce3597851110001cf6248971ea2d628e74c31a7db0572d1dbc101'; // https://openrouteservice.org/ で取得したキーを入力

        // 歩行速度（m/分）
        const WALKING_SPEED = 80;

        // 地図の初期化
        const map = L.map('map').setView([35.6762, 139.6503], 13); // デフォルト：東京
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let routeLayer = null;
        let currentLocationMarker = null;
        let isNavigating = false;
        let navigationMode = false;

        // 現在地の取得
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('このブラウザでは現在地取得がサポートされていません。');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('start').value = '現在地';
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    currentLocationMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'current-location-icon',
                            html: '<div style="background: #1a73e8; border-radius: 50%; width: 16px; height: 16px; border: 3px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [16, 16]
                        })
                    }).addTo(map);
                    map.setView([lat, lon], 15);
                },
                (error) => {
                    alert('現在地を取得できませんでした: ' + error.message);
                }
            );
        }

        // モード切替
        function toggleMode() {
            navigationMode = !navigationMode;
            document.getElementById('mode-toggle').textContent = navigationMode ? 'ナビモード' : 'パネルモード';
            updateNavigationDisplay();
        }

        // ナビゲーション表示の更新
        function updateNavigationDisplay() {
            const directions = document.getElementById('directions');
            const navigationBox = document.getElementById('navigation-box');
            if (navigationMode) {
                directions.style.display = 'none';
                navigationBox.style.display = 'block';
                document.getElementById('search-container').classList.add('hidden');
            } else {
                directions.style.display = 'block';
                navigationBox.style.display = 'none';
                if (!isNavigating) document.getElementById('search-container').classList.remove('hidden');
            }
        }

        // オートコンプリート（ORS Pelias API）
        async function autocomplete(input, suggestionsId) {
            const query = input.value;
            if (query.length < 3) {
                document.getElementById(suggestionsId).classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`https://api.openrouteservice.org/geocode/autocomplete?text=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': apiKey }
                });
                if (!response.ok) {
                    throw new Error(`オートコンプリートAPIエラー: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                const suggestions = document.getElementById(suggestionsId);
                suggestions.innerHTML = '';
                if (data.features.length > 0) {
                    data.features.forEach(feature => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.textContent = feature.properties.label;
                        item.onclick = () => {
                            input.value = feature.properties.label;
                            suggestions.classList.add('hidden');
                        };
                        suggestions.appendChild(item);
                    });
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            } catch (error) {
                console.error('オートコンプリートエラー:', error);
                alert('オートコンプリートに失敗しました: ' + error.message);
            }
        }

        // ジオコーディング（地名→座標）
        async function geocode(location) {
            if (location === '現在地') {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('現在地取得がサポートされていません'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve([position.coords.latitude, position.coords.longitude]),
                        (error) => reject(new Error('現在地を取得できませんでした: ' + error.message))
                    );
                });
            }
            try {
                const response = await fetch(`https://api.openrouteservice.org/geocode/search?text=${encodeURIComponent(location)}`, {
                    headers: { 'Authorization': apiKey }
                });
                if (!response.ok) {
                    throw new Error(`ジオコーディングAPIエラー: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                if (data.features.length > 0) {
                    return data.features[0].geometry.coordinates.reverse(); // [lat, lon]
                }
                throw new Error('場所が見つかりません');
            } catch (error) {
                throw new Error('ジオコーディングエラー: ' + error.message);
            }
        }

        // ルート検索
        async function findRoute() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const mode = document.getElementById('mode').value;
            if (!start || !end) {
                alert('出発地と目的地を両方入力してください');
                return;
            }

            try {
                // 出発地と目的地の座標を取得
                const startCoords = await geocode(start);
                const endCoords = await geocode(end);

                // 移動モードに応じたエンドポイント
                let endpoint = `https://api.openrouteservice.org/v2/directions/${mode}/geojson`;
                if (mode === 'public-transport') {
                    endpoint = 'https://api.openrouteservice.org/v2/directions/public-transport';
                }

                // ルート取得（案内含む）
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        coordinates: [startCoords.reverse(), endCoords.reverse()],
                        instructions: true
                    })
                });
                if (!response.ok) {
                    if (mode === 'public-transport') {
                        alert('公共交通機関のルート検索が制限されています。徒歩ルートに切り替えます。');
                        document.getElementById('mode').value = 'foot-walking';
                        return findRoute(); // 徒歩でリトライ
                    }
                    throw new Error(`ルートAPIエラー: ${response.status} ${response.statusText}`);
                }
                const routeData = await response.json();

                // 前のルートをクリア
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }

                // 新しいルートを地図に追加（Google Maps風の青い線）
                routeLayer = L.geoJSON(routeData, {
                    style: { color: '#1a73e8', weight: 5, opacity: 0.8 }
                }).addTo(map);
                map.fitBounds(routeLayer.getBounds());

                // ルート概要（歩行速度80m/分で再計算）
                const totalDistance = routeData.features[0].properties.summary.distance;
                const customDuration = Math.ceil(totalDistance / WALKING_SPEED);
                document.getElementById('route-summary').textContent = `距離: ${(totalDistance / 1000).toFixed(1)}km | 所要時間: ${customDuration}分`;
                document.getElementById('route-summary-bottom').textContent = `${(totalDistance / 1000).toFixed(1)}km - ${customDuration}:${(customDuration % 60).toString().padStart(2, '0')}`;

                // 案内を表示
                updateNavigationDisplay();
                if (navigationMode) {
                    updateNavigationBox(routeData.features[0].properties.segments[0].steps[0], (totalDistance / 1000).toFixed(1), customDuration);
                } else {
                    const instructionsList = document.getElementById('instructions');
                    instructionsList.innerHTML = '';
                    if (routeData.features && routeData.features[0].properties && routeData.features[0].properties.segments) {
                        routeData.features[0].properties.segments.forEach(segment => {
                            segment.steps.forEach((step, index) => {
                                const li = document.createElement('li');
                                li.className = `step-card ${index === 0 && start === '現在地' ? 'active' : ''}`;
                                const icon = getStepIcon(step.type);
                                const stepDistance = (step.distance / 1000).toFixed(1);
                                const stepDuration = Math.ceil(step.distance / WALKING_SPEED);
                                li.innerHTML = `
                                    <span class="step-icon">${icon}</span>
                                    <span class="step-info">${step.instruction}</span>
                                    <span class="step-distance">${stepDistance}km, ${stepDuration}分</span>
                                `;
                                instructionsList.appendChild(li);
                            });
                        });
                    } else {
                        instructionsList.innerHTML = '<li class="step-card">案内情報が利用できません</li>';
                    }
                }

                // ナビゲーション開始
                isNavigating = true;
                document.getElementById('search-container').classList.add('hidden');

                // 現在地の追跡
                if (start === '現在地' && navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            if (currentLocationMarker) {
                                map.removeLayer(currentLocationMarker);
                            }
                            currentLocationMarker = L.marker([lat, lon], {
                                icon: L.divIcon({
                                    className: 'current-location-icon',
                                    html: '<div style="background: #1a73e8; border-radius: 50%; width: 16px; height: 16px; border: 3px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.3);"></div>',
                                    iconSize: [16, 16]
                                })
                            }).addTo(map);
                            map.setView([lat, lon], 15);
                            if (navigationMode) {
                                updateNavigationBoxBasedOnLocation(routeData.features[0].properties.segments, lat, lon);
                            }
                        },
                        (error) => {
                            console.error('位置更新エラー:', error);
                        },
                        { enableHighAccuracy: true }
                    );
                }
            } catch (error) {
                console.error('ルートエラー:', error);
                alert('ルート検索に失敗しました: ' + error.message);
            }
        }

        // ステップのアイコンを取得
        function getStepIcon(type) {
            switch (type) {
                case 0: return '→'; // 直進
                case 1: return '↗'; // 右折
                case 2: return '↖'; // 左折
                case 10: return '🏁'; // 到着
                default: return '➡';
            }
        }

        // ナビゲーションボックスの更新
        function updateNavigationBox(step, totalDistance, totalDuration) {
            const box = document.getElementById('navigation-box');
            const icon = getNavigationIcon(step.type);
            const stepDistance = (step.distance / 1000).toFixed(1);
            const stepDuration = Math.ceil(step.distance / WALKING_SPEED);
            box.innerHTML = `
                <div class="navigation-icon">${icon}</div>
                <div class="navigation-text">${step.instruction}</div>
                <div class="navigation-distance">${stepDistance}km - ${stepDuration}分</div>
            `;
            box.style.display = 'block';
        }

        // ナビゲーションボックスの位置ベース更新（簡易実装）
        function updateNavigationBoxBasedOnLocation(segments, lat, lon) {
            const steps = segments.flatMap(segment => segment.steps);
            const currentStep = steps.find(step => {
                return Math.abs(step.way_points[0][0] - lat) < 0.01 && Math.abs(step.way_points[0][1] - lon) < 0.01;
            }) || steps[0];
            updateNavigationBox(currentStep, (segments[0].distance / 1000).toFixed(1), Math.ceil(segments[0].distance / WALKING_SPEED));
        }

        // ナビゲーションアイコンを取得
        function getNavigationIcon(type) {
            switch (type) {
                case 0: return '↑'; // 直進
                case 1: return '↗'; // 右折
                case 2: return '↖'; // 左折
                case 10: return '🏁'; // 到着
                default: return '→';
            }
        }

        // ナビゲーション終了
        function exitNavigation() {
            isNavigating = false;
            document.getElementById('search-container').classList.remove('hidden');
            document.getElementById('directions').style.display = 'none';
            document.getElementById('navigation-box').style.display = 'none';
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            document.getElementById('instructions').innerHTML = '';
            document.getElementById('route-summary').textContent = '';
            document.getElementById('route-summary-bottom').textContent = '';
            map.setView([35.6762, 139.6503], 13); // デフォルトビューにリセット
        }

        // オートコンプリートドロップダウンを外クリックで非表示
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('start-suggestions').classList.add('hidden');
                document.getElementById('end-suggestions').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
